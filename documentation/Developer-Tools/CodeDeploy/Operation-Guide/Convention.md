## 约定

**删除**

无论是删除应用、删除部署组、删除里程牌，均不会对部署目标云主机进行任何操作。对正在部署、正在回滚、正在手动终止的部署任务无影响。

**部署超时时间**

在部署任务中，单个实例的超时时间为5min，整个部署任务的超时时间为1h。

回滚超时时间等于部署超时时间。

**回滚**

- 回滚为部署任务粒度的回滚，而非单个实例的回滚
- 回滚将回退至上一个已知良好的版本
- 新的增量文件不会进行删除，只会把备份的旧文件恢复回来，主要是适用于同名文件策略选择“覆盖”的情况
- 与重新部署的区别：重新部署即重新开始一次部署任务，包括程序包的下载。而回滚将直接使用已下载的本地备份的程序包
- 仅支持非首次且为最新一次部署成功的部署任务的手动回滚操作
- 由于蓝绿部署的手动回滚操作仅进行流量的路由，不会对实例进行操作，因此实例状态依旧显示为“部署成功”
- 初次部署任务触发自动回滚后，由于无备份文件，因此将跳过恢复备份文件这一环节


**取消**

将取消正在部署的任务，请注意，已部署的实例不会进行回滚，即可能会出现一个部署组内，不同实例中程序包版本不一致的情况。也可能会出现部署任务已取消，但部署组内实例均部署成功的情况。


**负载均衡**

- 云部署不会自动创建负载均衡实例中的监听端口
- 在指定负载均衡实例中，监听器的数量有最大数限制，详见负载均衡产品文档
- 一个负载均衡后端服务，仅可关联一个负载均衡虚拟服务器组
- 非初次进行滚动部署时，将向已有负载均衡虚拟服务器组中添加或删除云主机
- 非初次进行蓝绿部署时，将新建虚拟服务器组，并删除旧虚拟服务器组
- 若选择使用负载均衡，那么所选部署目标中的云主机应与负载均衡实例所属同一子网中
- 由于负载均衡在添加虚拟服务器组或向已有虚拟服务器组中添加云主机时，会先进行健康检查，而后再开放流量，因此，会有一定的时间间隔，可依据实际情况决定是否开启健康检查
- 负载均衡虚拟服务器组中对应实例的端口默认为“-”，即继承负载均衡后端服务的端口；权重默认为“10”


**状态**

应用详情页、部署历史页、部署详情页的实例状态、部署详情页进度的总状态

![Alt text](https://github.com/jdcloudcom/cn/blob/codedeploy/image/CodeDeploy/operation21.png)


**工作流**

- hooks中的脚本，建议注意幂等性
- 执行停止脚本，即执行部署目标机中已备份的停止脚本，而非待部署的程序包中的停止脚本


**部署目录说明**

```
#缓存路径（程序包、解压）
${root dir}/app-${app id}/group-${group id}/deploy-${deploy id}/
#备份路径（备份）
${root dir}/.backup
```

其中的变量说明如下：

| 变量      |    解释 |
| :--------: | :--------:|
| ${root dir}  | /home |
| ${app id}  | 应用ID，可在部署应用页面查看 |
| ${group id}  | 部署组ID，可在应用详情页查看 |
| ${deploy id}  | 部署任务ID，可在部署历史页查看 |

为保证回滚成功，建议不要删除备份路径下的文件。
